// Private University Database Schema
// Each university has its own isolated database with this schema
// Contains: Students, Courses, Enrollments, Achievements, Certificates, ZKPProofRequests

generator client {
  provider = "prisma-client-js"
  output   = "../node_modules/.prisma/university"
}

datasource db {
  provider = "postgresql"
  url      = env("UNIVERSITY_DATABASE_URL")
}

// Students enrolled in this university
model Student {
  id String @id @default(cuid())

  // Identifiers
  walletAddress String? @unique // Solana wallet address
  email         String  @unique
  nicHash       String  @unique // SHA-256 hash (links to GlobalStudentIndex)

  // Personal info
  fullName       String
  studentNumber  String  @unique // University-specific ID
  program        String? // e.g., "Computer Science"
  department     String? // e.g., "Engineering"
  enrollmentYear Int?
  graduationYear Int?

  // Profile
  profilePicUrl String?
  phoneNumber   String?
  address       String?

  // Status
  isActive Boolean @default(true)

  // Relationships
  enrollments      Enrollment[]
  certificates     Certificate[]
  achievements     StudentAchievement[]
  zkpRequests      ZKPProofRequest[]
  verificationLogs VerificationLog[]
  notifications    StudentNotification[]

  // Metadata
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([walletAddress])
  @@index([email])
  @@index([nicHash])
  @@index([studentNumber])
  @@map("students")
}

// Courses offered by the university
model Course {
  id String @id @default(cuid())

  // Course info
  name        String
  code        String  @unique
  description String? @db.Text
  credits     Int?

  // Department
  department String?
  level      String? // "Undergraduate", "Graduate"

  // Relationships
  enrollments Enrollment[]

  // Metadata
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([code])
  @@index([department])
  @@map("courses")
}

// Student course enrollments
model Enrollment {
  id String @id @default(cuid())

  // Relations
  studentId String
  student   Student @relation(fields: [studentId], references: [id], onDelete: Cascade)

  courseId String
  course   Course @relation(fields: [courseId], references: [id], onDelete: Cascade)

  // Academic details
  gpa         Float?
  grade       String? // "A", "B+", etc.
  batchYear   Int
  completedAt DateTime?

  // Relationships
  achievements Achievement[]
  certificates Certificate[]

  // Metadata
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([studentId, courseId, batchYear])
  @@index([studentId])
  @@index([courseId])
  @@index([batchYear])
  @@map("enrollments")
}

// Student achievements (badges, honors, awards)
model Achievement {
  id String @id @default(cuid())

  // Relations
  enrollmentId String?
  enrollment   Enrollment? @relation(fields: [enrollmentId], references: [id], onDelete: Cascade)

  // Achievement details
  badgeTitle      String
  description     String?   @db.Text
  badgeType       String? // "ACADEMIC", "EXTRACURRICULAR", "RESEARCH", "LEADERSHIP"
  semester        String?
  achievementDate DateTime?

  // ZKP support for privacy-preserving proofs
  zkpCommitmentHash String? // Hash commitment for ZK proofs
  zkpPublicInputs   String? @db.Text // JSON of public inputs
  proofGenerated    Boolean @default(false)

  // Icon/image
  iconUrl String?

  // Relationships
  zkpRequests ZKPProofRequest[]

  // Metadata
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([enrollmentId])
  @@index([badgeType])
  @@map("achievements")
}

// Achievement catalog entries that can be linked to students
model AchievementCatalog {
  id          String   @id @default(cuid())
  title       String
  description String?
  category    String?
  isActive    Boolean  @default(true) @map("is_active")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  students StudentAchievement[]

  @@unique([title])
  @@map("achievement_catalog")
}

// Join table linking students to catalog achievements
model StudentAchievement {
  id            String   @id @default(cuid())
  studentId     String   @map("student_id")
  achievementId String   @map("achievement_id")
  awardedAt     DateTime @default(now()) @map("awarded_at")
  notes         String?

  student     Student            @relation(fields: [studentId], references: [id], onDelete: Cascade)
  achievement AchievementCatalog @relation(fields: [achievementId], references: [id], onDelete: Cascade)

  @@unique([studentId, achievementId])
  @@index([achievementId])
  @@map("student_achievements")
}

// Issued certificates (references to cNFTs on Solana)
model Certificate {
  id String @id @default(cuid())

  // Relations
  studentId String
  student   Student @relation(fields: [studentId], references: [id], onDelete: Cascade)

  enrollmentId String?
  enrollment   Enrollment? @relation(fields: [enrollmentId], references: [id])

  // Certificate details
  certificateNumber String  @unique
  badgeTitle        String
  description       String? @db.Text
  degreeType        String? // "Bachelor", "Master", "PhD", "Diploma", "Certificate"

  // Blockchain references
  mintAddress          String  @unique // Compressed NFT asset ID on Solana
  merkleTreeAddress    String? // Bubblegum Merkle tree address
  leafIndex            BigInt? // Position in Merkle tree
  ipfsMetadataUri      String // IPFS URI for metadata
  transactionSignature String? @unique

  // Certificate metadata (flexible JSON)
  metadataJson String @db.Text // Full certificate metadata

  // Achievements included in this certificate
  achievementIds String[] // Array of achievement IDs

  // Status
  status     String    @default("PENDING") // PENDING, MINTED, FAILED
  issuedAt   DateTime  @default(now())
  expiryDate DateTime?

  // Revocation (also tracked in shared DB)
  revoked                    Boolean   @default(false)
  revokedAt                  DateTime?
  revocationReason           String?
  revocationTransactionSignature String? @unique // Burn transaction signature

  // Issued by
  issuedByAdminId String?

  // Relationships
  verificationLogs VerificationLog[]

  // Metadata
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([studentId])
  @@index([mintAddress])
  @@index([certificateNumber])
  @@index([status])
  @@index([revoked])
  @@map("certificates")
}

// ZKP proof requests for selective disclosure
model ZKPProofRequest {
  id String @id @default(cuid())

  // Relations
  studentId String
  student   Student @relation(fields: [studentId], references: [id], onDelete: Cascade)

  achievementId String?
  achievement   Achievement? @relation(fields: [achievementId], references: [id])

  // Proof details
  claimType String // e.g., "GPA_ABOVE_3_5", "DEGREE_OBTAINED", "HAS_BADGE"
  claimData String? @db.Text // JSON of claim parameters

  // ZK proof data (generated by student)
  proofJson    String? @db.Text // Full ZK proof
  publicInputs String? @db.Text // Public inputs for verification

  // Verification
  verified           Boolean   @default(false)
  verifiedAt         DateTime?
  verificationResult String?   @db.Text

  // Requester info (employer, etc.)
  requesterEmail   String?
  requesterCompany String?
  purpose          String? // Why this proof is needed

  // Expiry
  expiresAt DateTime

  // Share link (optional)
  shareToken String? @unique
  shareUrl   String?

  // Metadata
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([studentId])
  @@index([achievementId])
  @@index([verified])
  @@index([expiresAt])
  @@index([shareToken])
  @@map("zkp_proof_requests")
}

// Certificate templates for standardized issuance
model CertificateTemplate {
  id String @id @default(cuid())

  // Template info
  name        String // e.g., "Bachelor of Science"
  degreeType  String // "Bachelor", "Master", "PhD", "Diploma"
  description String? @db.Text

  // Template fields (JSON schema)
  templateFields String @db.Text // JSON: { "gpa": "number", "honors": "string", etc }

  // Design
  designTemplate  String? @db.Text // SVG or design specification
  backgroundImage String? // URL to background image

  // Status
  isActive Boolean @default(true)

  // Usage stats
  timesUsed Int @default(0)

  // Metadata
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([degreeType])
  @@index([isActive])
  @@map("certificate_templates")
}

// Batch certificate issuance jobs (client-side signing)
model BatchIssuanceJob {
  id           String @id @default(cuid())
  universityId String

  // Job details
  batchName         String?
  totalCertificates Int

  // Progress
  status         String @default("PENDING") // PENDING, PROCESSING, COMPLETED, FAILED, CANCELLED
  processedCount Int    @default(0)
  successCount   Int    @default(0)
  failedCount    Int    @default(0)

  // Certificate IDs in this batch
  certificateIds String[] // Array of certificate IDs to mint

  // Results tracking
  successfulMints String[] @default([]) // Certificate IDs that succeeded
  failedMints     String?  @db.Text // JSON: [{certId, error, attempts, timestamp}]

  // Detailed results
  resultsJson String? @db.Text // JSON array of all results with signatures

  // Timestamps
  createdAt   DateTime  @default(now())
  startedAt   DateTime?
  completedAt DateTime?

  // Created by
  createdByAdminId String?

  @@index([universityId])
  @@index([status])
  @@index([createdAt])
  @@map("batch_issuance_jobs")
}

// Verification logs - tracks when certificates are verified
model VerificationLog {
  id String @id @default(cuid())

  // Relations
  studentId String
  student   Student @relation(fields: [studentId], references: [id], onDelete: Cascade)

  certificateId String
  certificate   Certificate @relation(fields: [certificateId], references: [id], onDelete: Cascade)

  // Verification details
  verifiedAt         DateTime @default(now())
  verificationType   String   @default("PUBLIC") // PUBLIC, ZKP, API
  verificationStatus String   @default("SUCCESS") // SUCCESS, FAILED

  // Verifier information (if available)
  verifierIpAddress String?
  verifierLocation  String? // Country/City derived from IP
  verifierUserAgent String? @db.Text // Browser/device info

  // Additional context
  certificateNumber String // Denormalized for quick access
  mintAddress       String // Denormalized for quick access

  // Error tracking (if verification failed)
  errorMessage String? @db.Text

  // Metadata
  createdAt DateTime @default(now())

  @@index([studentId])
  @@index([certificateId])
  @@index([verifiedAt])
  @@index([verificationStatus])
  @@index([mintAddress])
  @@map("verification_logs")
}

// =============================================================================
// ZK Achievement Verification Tables (Phase 1)
// =============================================================================

// ZK Achievement Commitments
// Stores the Poseidon commitment for each (credential, achievement) pair
// Commitment = Poseidon(credential_hash, student_secret, salt, achievement_hash)
model ZkAchievementCommitment {
  id String @id @default(cuid())

  // Foreign keys (denormalized for query efficiency)
  credentialId    String // Solana mintAddress (certificate identifier)
  achievementCode String // Achievement identifier (badgeTitle)

  // ZK data
  circuitId  String @default("ach_member_v1") // Circuit version
  commitment String // Poseidon commitment as decimal string

  // Track which wallet was used (for mismatch detection)
  walletPubkey String // Wallet public key that generated this commitment

  // Metadata
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  proofs ZkAchievementProof[]

  @@unique([credentialId, achievementCode])
  @@index([credentialId])
  @@index([achievementCode])
  @@index([walletPubkey])
  @@map("zk_achievement_commitments")
}

// ZK Achievement Proofs
// Stores pre-generated Groth16 proofs that employers can verify
model ZkAchievementProof {
  id String @id @default(cuid())

  // Foreign keys
  credentialId    String
  achievementCode String

  // Link to commitment
  commitmentId String
  commitment   ZkAchievementCommitment @relation(fields: [commitmentId], references: [id], onDelete: Cascade)

  // ZK data
  circuitId     String @default("ach_member_v1")
  proofJson     Json   // Groth16 proof object {pi_a, pi_b, pi_c, protocol, curve}
  publicSignals Json   // Array of public inputs as strings [commitment, credential_hash, achievement_hash]
  proofHash     String // SHA256 of proof for audit trail

  // Verification status
  verified          Boolean   @default(false)
  verifiedAt        DateTime?
  lastVerifiedAt    DateTime?
  verificationCount Int       @default(0)

  // Expiry (optional, for future use)
  expiresAt DateTime?

  // Metadata
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Audit logs
  auditLogs ZkProofAuditLog[]

  @@unique([credentialId, achievementCode])
  @@index([credentialId])
  @@index([proofHash])
  @@index([verified])
  @@map("zk_achievement_proofs")
}

// ZK Proof Audit Logs
// Tracks every verification attempt for compliance and debugging
model ZkProofAuditLog {
  id String @id @default(cuid())

  // Foreign keys
  credentialId    String
  achievementCode String
  proofId         String?
  proof           ZkAchievementProof? @relation(fields: [proofId], references: [id], onDelete: SetNull)

  // Verification result
  verifiedAt    DateTime @default(now())
  success       Boolean
  failureReason String?  @db.Text

  // Requester info
  requesterIp    String?
  requesterAgent String? @db.Text

  // Proof identity
  proofHash String // Hash of proof at time of verification

  // Metadata
  createdAt DateTime @default(now())

  @@index([credentialId, achievementCode])
  @@index([verifiedAt])
  @@index([proofHash])
  @@index([success])
  @@map("zk_proof_audit_logs")
}

// =============================================================================
// In-App Notification System (Student Notifications)
// =============================================================================

enum StudentNotificationType {
  // Certificate events
  CERTIFICATE_ISSUED
  CERTIFICATE_MINTED
  CERTIFICATE_REVOKED
  CERTIFICATE_VERIFIED
  // ZK events
  ZK_COMMITMENT_REGISTERED
  ZK_PROOF_UPLOADED
  ZK_PROOF_VERIFIED
  ZK_PROOF_FAILED
  // Achievement events
  ACHIEVEMENT_AWARDED
  // Enrollment events
  ENROLLMENT_ADDED
  // Security events
  SECURITY_NEW_LOGIN
  SECURITY_WALLET_LINKED
  // System events
  SYSTEM_ANNOUNCEMENT
}

enum StudentNotificationPriority {
  LOW
  NORMAL
  HIGH
  URGENT
}

// Notifications for Students (stored per-university database)
model StudentNotification {
  id              String                      @id @default(cuid())

  // Recipient
  studentId       String
  student         Student                     @relation(fields: [studentId], references: [id], onDelete: Cascade)

  // Content
  type            StudentNotificationType
  title           String
  message         String                      @db.Text
  priority        StudentNotificationPriority @default(NORMAL)

  // Optional metadata (JSON for flexibility)
  metadata        Json?                       // { certificateId, achievementId, etc. }
  actionUrl       String?                     // Deep link to relevant page

  // Status
  read            Boolean                     @default(false)
  readAt          DateTime?

  // Timestamps
  createdAt       DateTime                    @default(now())
  expiresAt       DateTime?                   // Auto-cleanup old notifications

  @@index([studentId, read])
  @@index([studentId, createdAt])
  @@index([type])
  @@map("student_notifications")
}
